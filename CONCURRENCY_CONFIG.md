# 串行执行配置说明

本文档说明了GitHub自动打卡系统中的串行执行配置参数，这些参数可以帮助您优化多账户串行提交时的性能和稳定性，避免合并冲突。

## 配置位置

并发控制配置位于 `config.py` 文件中的 `CONCURRENCY_CONFIG` 字典。

## 配置参数详解

### 基础执行设置

- **`max_workers`** (默认: 1)
  - 最大并发线程数，设为1确保串行执行
  - 建议值: 1（串行模式）
  - 说明: 设为1可避免多账户同时提交导致的合并冲突

### 串行执行设置

- **`serial_execution_delay`** (默认: 30)
  - 串行执行时账号间的基础延迟（秒）
  - 建议值: 20-60
  - 说明: 每个账号完成后到下一个账号开始的等待时间

- **`serial_execution_increment`** (默认: 15)
  - 串行执行时每个账号的额外延迟（秒）
  - 建议值: 10-30
  - 说明: 后续账号会在基础延迟基础上额外增加的时间

- **`base_delay_range`** (默认: (5.0, 10.0))
  - 基础延迟范围（秒）
  - 说明: 在串行模式下主要用于重试时的随机延迟
  - 用途: 增加操作的随机性，避免固定模式

### 重试机制设置

- **`max_retries_per_account`** (默认: 3)
  - 每个账户的最大重试次数
  - 建议值: 2-5
  - 说明: 当检测到冲突时，每个账户最多重试的次数

- **`retry_delay_range`** (默认: (10.0, 20.0))
  - 重试延迟范围（秒）
  - 说明: 重试前的随机等待时间范围
  - 用途: 在串行模式下给当前账户更多时间等待冲突解决

### PR合并设置

- **`merge_retry_count`** (默认: 8)
  - PR合并的最大重试次数
  - 建议值: 5-10
  - 说明: PR合并失败时的重试次数

- **`merge_retry_backoff`** (默认: 1.5)
  - PR合并重试的退避系数
  - 说明: 每次重试的等待时间会按此系数递增
  - 计算公式: `wait_time = base_time * (backoff_factor ^ attempt)`

### 智能重试设置

- **`enable_smart_retry`** (默认: True)
  - 启用智能重试机制
  - 说明: 只对检测到的冲突进行重试，其他错误直接失败

- **`conflict_detection_keywords`** (默认: 见配置文件)
  - 冲突检测关键词列表
  - 说明: 用于识别是否为合并冲突的关键词
  - 可根据实际遇到的错误信息进行调整

## 调优建议

### 标准串行模式（推荐）
```python
CONCURRENCY_CONFIG = {
    "max_workers": 1,  # 确保串行执行
    "serial_execution_delay": 30,  # 账号间基础延迟
    "serial_execution_increment": 15,  # 递增延迟
    "enable_smart_retry": True,  # 启用智能重试
    # ... 其他配置保持默认
}
```

### 快速串行模式（少量账户）
```python
CONCURRENCY_CONFIG = {
    "max_workers": 1,
    "serial_execution_delay": 20,  # 减少基础延迟
    "serial_execution_increment": 10,  # 减少递增延迟
    "max_retries_per_account": 2,  # 减少重试次数
    # ... 其他配置保持默认
}
```

### 稳定串行模式（大量账户或网络不稳定）
```python
CONCURRENCY_CONFIG = {
    "max_workers": 1,
    "serial_execution_delay": 45,  # 增加基础延迟
    "serial_execution_increment": 20,  # 增加递增延迟
    "merge_retry_count": 12,  # 增加PR合并重试次数
    "max_retries_per_account": 5,  # 增加重试次数
    # ... 其他配置保持默认
}
```

## 串行执行模式优势

### 🛡️ 冲突避免
- **零冲突**: 完全避免多账户同时提交导致的合并冲突
- **稳定可靠**: 每个账户都能成功完成提交-合并流程
- **无需干预**: 自动处理所有冲突检测和重试

### 📊 执行保障
- **完整流程**: 确保每个账户完成提交→PR→合并→清理的完整周期
- **状态跟踪**: 实时监控每个账户的执行状态和进度
- **错误隔离**: 单个账户失败不影响其他账户的处理

### ⏱️ 时间可控
- **可预测**: 执行时间可根据账户数量和延迟配置预估
- **可调节**: 可根据实际需求调整延迟参数
- **智能重试**: 只在必要时进行重试，避免无效等待

## 监控和调试

1. **查看日志**: 系统会记录详细的串行执行和重试信息
2. **成功率统计**: 关注最终的成功/失败统计
3. **执行时间**: 监控每个账户的处理时间和总体执行时间
4. **延迟效果**: 观察延迟设置对冲突避免的效果
5. **调整策略**: 根据实际运行情况调整参数

## 常见问题

**Q: 为什么还会出现PR合并冲突？**
A: 即使文件路径不同，GitHub的合并机制仍可能检测到冲突。通过增加延迟和重试可以缓解此问题。

**Q: 如何减少API调用次数？**
A: 降低 `max_workers` 和增加 `base_delay_range`，减少并发请求。

**Q: 重试次数设置多少合适？**
A: 建议根据账户数量调整：2-3个账户设置2-3次，5+账户设置3-5次。